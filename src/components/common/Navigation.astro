---
/**
 * @component Navigation
 * @description 顶部导航栏组件，支持桌面端和移动端响应式布局
 * @features 当前页高亮、移动端菜单、主题切换、Swup 兼容
 * @usage 在 BaseLayout 中引用
 */
import ThemeIcon from "@components/widgets/ThemeIcon.astro";
import { Icon } from "astro-icon/components";

interface NavItem {
  label: string;
  href: string;
  icon: string;
}

const navItems: NavItem[] = [
  { label: '首页', href: '/', icon: 'lucide:home' },
  { label: '文章', href: '/blog', icon: 'lucide:file-text' },
  { label: '工具箱', href: '/links', icon: 'lucide:box' },
  { label: '关于', href: '/about', icon: 'lucide:user' },
  { label: '远程', href: '/remote', icon: 'lucide:monitor' }
];

const currentPath = Astro.url.pathname;
---

<header class="fixed top-0 left-0 right-0 z-50 glass" data-current-path={currentPath}>
  <nav class="container-wide h-16 flex items-center justify-between">
    <!-- Logo -->
    <a href="/" class="text-lg font-semibold tracking-tight hover:opacity-70 transition-opacity flex items-center gap-2 group">
      <Icon name="lucide:moon" class="w-5 h-5 text-indigo-500 group-hover:animate-pulse" />
      <span>Moonpeak</span>
    </a>
    
    <!-- Desktop Nav -->
    <div class="hidden md:flex items-center gap-1" id="desktop-nav">
      {navItems.map((item) => (
        <a
          href={item.href}
          data-nav-item
          data-href={item.href}
          class="nav-link relative px-4 py-2 text-sm rounded-lg nav-link-interactive flex items-center gap-2 group"
        >
          <Icon name={item.icon} class="w-4 h-4 transition-transform duration-300 group-hover:scale-110 group-hover:-translate-y-0.5" />
          <span>{item.label}</span>
        </a>
      ))}
      <div class="pl-3 ml-2 border-l border-border flex items-center gap-2">
        <!-- Search Button -->
        <a 
          href="/search" 
          class="w-8 h-8 rounded-full flex items-center justify-center interactive-btn"
          aria-label="搜索"
        >
          <Icon name="lucide:search" class="w-4 h-4 transition-transform duration-300 group-hover:scale-110" />
        </a>
        <ThemeIcon size="sm" variant="icon" />
      </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <div class="flex items-center gap-3 md:hidden">
      <!-- Search Button Mobile -->
      <a 
        href="/search" 
        class="p-2 text-muted-foreground hover:text-foreground transition-colors"
        aria-label="搜索"
      >
        <Icon name="lucide:search" class="w-5 h-5" />
      </a>
      <ThemeIcon size="sm" variant="icon" />
      <button
        id="mobile-menu-btn"
        class="p-2 -mr-2 text-muted-foreground hover:text-foreground transition-colors"
        aria-label="菜单"
        aria-expanded="false"
      >
        <Icon name="lucide:menu" id="menu-icon" class="w-5 h-5" />
        <Icon name="lucide:x" id="close-icon" class="w-5 h-5 hidden" />
      </button>
    </div>
  </nav>
  
  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-border/80 bg-background/95 backdrop-blur-sm"
  >
    <div class="container-wide py-3 space-y-1" id="mobile-nav-items">
      <!-- Search in mobile menu -->
      <a
        href="/search"
        data-mobile-nav-item
        data-href="/search"
        class="mobile-nav-link block px-4 py-3 rounded-lg text-base nav-link-interactive"
      >
        <div class="flex items-center gap-3">
          <Icon name="lucide:search" class="w-5 h-5" />
          <span class="nav-label">搜索</span>
        </div>
      </a>
      {navItems.map((item) => (
        <a
          href={item.href}
          data-mobile-nav-item
          data-href={item.href}
          class="mobile-nav-link block px-4 py-3 rounded-lg text-base nav-link-interactive"
        >
          <div class="flex items-center gap-3">
            <Icon name={item.icon} class="w-5 h-5" />
            <span class="nav-label">{item.label}</span>
          </div>
        </a>
      ))}
    </div>
  </div>
</header>

<script is:inline data-swup-ignore-script>
  (function() {
    // 判断是否是当前页面
    function isActive(itemHref, currentPath) {
      if (itemHref === '/') {
        return currentPath === '/';
      }
      return currentPath === itemHref || currentPath.startsWith(itemHref + '/');
    }
    
    // 更新导航高亮状态
    function updateNavHighlight() {
      const currentPath = window.location.pathname;
      
      // 更新桌面导航
      document.querySelectorAll('[data-nav-item]').forEach(link => {
        const href = link.getAttribute('data-href');
        const indicator = link.querySelector('.nav-indicator');
        
        if (isActive(href, currentPath)) {
          link.classList.remove('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.add('text-foreground', 'font-medium', 'bg-muted');
          if (indicator) indicator.classList.remove('opacity-0');
        } else {
          link.classList.add('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.remove('text-foreground', 'font-medium', 'bg-muted');
          if (indicator) indicator.classList.add('opacity-0');
        }
      });
      
      // 更新移动端导航
      document.querySelectorAll('[data-mobile-nav-item]').forEach(link => {
        const href = link.getAttribute('data-href');
        const label = link.querySelector('.nav-label');
        const icon = link.querySelector('[data-icon]');
        
        if (isActive(href, currentPath)) {
          link.classList.remove('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.add('text-foreground', 'font-medium', 'bg-muted');
          if (icon) icon.classList.add('text-indigo-500');
        } else {
          link.classList.add('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.remove('text-foreground', 'font-medium', 'bg-muted');
          if (icon) icon.classList.remove('text-indigo-500');
        }
      });
    }
    
    // 初始化移动菜单
    function initMobileMenu() {
      const btn = document.getElementById('mobile-menu-btn');
      const menu = document.getElementById('mobile-menu');
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');
      
      if (!btn || !menu) return;
      
      // 移除旧的事件监听器（通过克隆节点）
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      // 重新获取元素
      const newMenuBtn = document.getElementById('mobile-menu-btn');
      const newMenuIcon = document.getElementById('menu-icon');
      const newCloseIcon = document.getElementById('close-icon');
      
      newMenuBtn.addEventListener('click', () => {
        const isExpanded = newMenuBtn.getAttribute('aria-expanded') === 'true';
        newMenuBtn.setAttribute('aria-expanded', String(!isExpanded));
        menu.classList.toggle('hidden');
        newMenuIcon.classList.toggle('hidden');
        newCloseIcon.classList.toggle('hidden');
      });
      
      // 点击链接后关闭菜单
      menu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          menu.classList.add('hidden');
          newMenuIcon.classList.remove('hidden');
          newCloseIcon.classList.add('hidden');
          newMenuBtn.setAttribute('aria-expanded', 'false');
        });
      });
    }
    
    // 初始化
    function init() {
      updateNavHighlight();
      initMobileMenu();
    }
    
    // 页面加载时初始化
    init();
    
    // 使用 SwupCompat 统一处理页面切换
    if (window.SwupCompat) {
      window.SwupCompat.onPageView(init);
    } else {
      // 降级处理
      document.addEventListener('swup:enable', () => {
        window.swup?.hooks?.on('page:view', init);
      });
      document.addEventListener('astro:page-load', init);
    }
    
    // 监听 URL 变化（备用方案）
    window.addEventListener('popstate', updateNavHighlight);
  })();
</script>
