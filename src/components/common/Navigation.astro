---
// 极简导航栏
import ThemeIcon from "@components/widgets/ThemeIcon.astro";

interface NavItem {
  label: string;
  href: string;
}

const navItems: NavItem[] = [
  { label: '首页', href: '/' },
  { label: '文章', href: '/blog' },
  { label: '工具箱', href: '/links' },
  { label: '关于', href: '/about' },
];

const currentPath = Astro.url.pathname;
---

<header class="fixed top-0 left-0 right-0 z-50 glass" data-current-path={currentPath}>
  <nav class="container-wide h-16 flex items-center justify-between">
    <!-- Logo -->
    <a href="/" class="text-lg font-semibold tracking-tight hover:opacity-70 transition-opacity">
      Moonpeak
    </a>
    
    <!-- Desktop Nav -->
    <div class="hidden md:flex items-center gap-1" id="desktop-nav">
      {navItems.map((item) => (
        <a
          href={item.href}
          data-nav-item
          data-href={item.href}
          class="nav-link relative px-4 py-2 text-sm rounded-lg transition-all duration-200 text-muted-foreground hover:text-foreground hover:bg-muted/50"
        >
          {item.label}
          <span class="nav-indicator absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-indigo-500 opacity-0 transition-opacity"></span>
        </a>
      ))}
      <div class="pl-3 ml-2 border-l border-border flex items-center gap-2">
        <!-- Search Button -->
        <a 
          href="/search" 
          class="w-8 h-8 rounded-full flex items-center justify-center text-muted-foreground hover:text-foreground hover:bg-muted transition-all"
          aria-label="搜索"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </a>
        <ThemeIcon size="sm" variant="icon" />
      </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <div class="flex items-center gap-3 md:hidden">
      <!-- Search Button Mobile -->
      <a 
        href="/search" 
        class="p-2 text-muted-foreground hover:text-foreground transition-colors"
        aria-label="搜索"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </a>
      <ThemeIcon size="sm" variant="icon" />
      <button
        id="mobile-menu-btn"
        class="p-2 -mr-2 text-muted-foreground hover:text-foreground transition-colors"
        aria-label="菜单"
        aria-expanded="false"
      >
        <svg id="menu-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <svg id="close-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </nav>
  
  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-border bg-background"
  >
    <div class="container-wide py-3 space-y-1" id="mobile-nav-items">
      <!-- Search in mobile menu -->
      <a
        href="/search"
        data-mobile-nav-item
        data-href="/search"
        class="mobile-nav-link block px-4 py-3 rounded-lg text-base transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50"
      >
        <div class="flex items-center gap-3">
          <span class="nav-dot w-1.5 h-1.5 rounded-full bg-indigo-500 opacity-0 transition-opacity"></span>
          <span class="nav-label pl-3.5">搜索</span>
        </div>
      </a>
      {navItems.map((item) => (
        <a
          href={item.href}
          data-mobile-nav-item
          data-href={item.href}
          class="mobile-nav-link block px-4 py-3 rounded-lg text-base transition-colors text-muted-foreground hover:text-foreground hover:bg-muted/50"
        >
          <div class="flex items-center gap-3">
            <span class="nav-dot w-1.5 h-1.5 rounded-full bg-indigo-500 opacity-0 transition-opacity"></span>
            <span class="nav-label">{item.label}</span>
          </div>
        </a>
      ))}
    </div>
  </div>
</header>

<script is:inline>
  (function() {
    // 判断是否是当前页面
    function isActive(itemHref, currentPath) {
      if (itemHref === '/') {
        return currentPath === '/';
      }
      return currentPath === itemHref || currentPath.startsWith(itemHref + '/');
    }
    
    // 更新导航高亮状态
    function updateNavHighlight() {
      const currentPath = window.location.pathname;
      
      // 更新桌面导航
      document.querySelectorAll('[data-nav-item]').forEach(link => {
        const href = link.getAttribute('data-href');
        const indicator = link.querySelector('.nav-indicator');
        
        if (isActive(href, currentPath)) {
          link.classList.remove('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.add('text-foreground', 'font-medium', 'bg-muted');
          if (indicator) indicator.classList.remove('opacity-0');
        } else {
          link.classList.add('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.remove('text-foreground', 'font-medium', 'bg-muted');
          if (indicator) indicator.classList.add('opacity-0');
        }
      });
      
      // 更新移动端导航
      document.querySelectorAll('[data-mobile-nav-item]').forEach(link => {
        const href = link.getAttribute('data-href');
        const dot = link.querySelector('.nav-dot');
        const label = link.querySelector('.nav-label');
        
        if (isActive(href, currentPath)) {
          link.classList.remove('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.add('text-foreground', 'font-medium', 'bg-muted');
          if (dot) dot.classList.remove('opacity-0');
          if (label) label.classList.remove('pl-3.5');
        } else {
          link.classList.add('text-muted-foreground', 'hover:text-foreground', 'hover:bg-muted/50');
          link.classList.remove('text-foreground', 'font-medium', 'bg-muted');
          if (dot) dot.classList.add('opacity-0');
          if (label) label.classList.add('pl-3.5');
        }
      });
    }
    
    // 初始化移动菜单
    function initMobileMenu() {
      const btn = document.getElementById('mobile-menu-btn');
      const menu = document.getElementById('mobile-menu');
      const menuIcon = document.getElementById('menu-icon');
      const closeIcon = document.getElementById('close-icon');
      
      if (!btn || !menu) return;
      
      // 移除旧的事件监听器（通过克隆节点）
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      // 重新获取元素
      const newMenuBtn = document.getElementById('mobile-menu-btn');
      const newMenuIcon = document.getElementById('menu-icon');
      const newCloseIcon = document.getElementById('close-icon');
      
      newMenuBtn.addEventListener('click', () => {
        const isExpanded = newMenuBtn.getAttribute('aria-expanded') === 'true';
        newMenuBtn.setAttribute('aria-expanded', String(!isExpanded));
        menu.classList.toggle('hidden');
        newMenuIcon.classList.toggle('hidden');
        newCloseIcon.classList.toggle('hidden');
      });
      
      // 点击链接后关闭菜单
      menu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          menu.classList.add('hidden');
          newMenuIcon.classList.remove('hidden');
          newCloseIcon.classList.add('hidden');
          newMenuBtn.setAttribute('aria-expanded', 'false');
        });
      });
    }
    
    // 初始化
    function init() {
      updateNavHighlight();
      initMobileMenu();
    }
    
    // 页面加载时初始化
    init();
    
    // 兼容 Swup - 页面过渡完成后重新初始化
    document.addEventListener('swup:enable', () => {
      window.swup?.hooks?.on('page:view', init);
    });
    
    // 兼容 Astro View Transitions
    document.addEventListener('astro:page-load', init);
    
    // 监听 URL 变化（备用方案）
    window.addEventListener('popstate', updateNavHighlight);
  })();
</script>
