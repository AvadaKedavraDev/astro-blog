---
/**
 * @component ArticleDrawer
 * @description 文章预览抽屉组件，点击文章内链时以抽屉形式预览内容
 * @features 抽屉打开/关闭、文章内容加载、新标签页打开
 * @usage 在 ArticleLayout 中引用，自动绑定文章内链点击事件
 */
---

<!-- 抽屉 DOM 结构 -->
<div id="article-drawer-overlay" class="fixed inset-0 bg-black/30 dark:bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm"></div>

<aside id="article-drawer" class="fixed top-0 right-0 h-full w-full sm:w-[600px] lg:w-[700px] bg-background z-50 transform translate-x-full transition-transform duration-300 ease-out shadow-2xl flex flex-col">
    <!-- 抽屉头部 -->
    <div class="flex items-center justify-between px-5 py-4 border-b border-border bg-muted/30 shrink-0">
        <div class="flex items-center gap-2 text-sm text-muted-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
            <span>文章预览</span>
        </div>
        <div class="flex items-center gap-2">
            <a id="drawer-open-newtab" href="#" target="_blank" class="p-2 text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors" title="在新标签页打开">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
            </a>
            <button id="drawer-close" class="p-2 text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors" aria-label="关闭抽屉">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
    </div>
    
    <!-- 抽屉内容区 -->
    <div id="drawer-content" class="flex-1 overflow-y-auto">
        <div id="drawer-loading" class="hidden flex-col items-center justify-center h-full py-20">
            <div class="w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-sm text-muted-foreground">加载中...</p>
        </div>
        <div id="drawer-article" class="hidden p-6 md:p-8"></div>
        <div id="drawer-error" class="hidden flex-col items-center justify-center h-full py-20 text-center px-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground mb-4"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            <p class="text-muted-foreground mb-2">文章加载失败</p>
            <a id="drawer-error-link" href="#" class="text-indigo-600 dark:text-indigo-400 hover:underline text-sm">直接访问文章 →</a>
        </div>
    </div>
</aside>

<script is:inline data-swup-ignore-script>
// @ts-nocheck - 这是一个纯 JavaScript 文件，禁用 TypeScript 检查
(function() {
    'use strict';
    
    // 抽屉状态
    const state = {
        drawer: null,
        overlay: null,
        loading: null,
        article: null,
        error: null,
        closeBtn: null,
        openNewtab: null,
        errorLink: null,
        isOpen: false,
        currentUrl: null
    };
    
    // 初始化 DOM 元素引用
    function initElements() {
        state.drawer = document.getElementById('article-drawer');
        state.overlay = document.getElementById('article-drawer-overlay');
        state.loading = document.getElementById('drawer-loading');
        state.article = document.getElementById('drawer-article');
        state.error = document.getElementById('drawer-error');
        state.closeBtn = document.getElementById('drawer-close');
        state.openNewtab = document.getElementById('drawer-open-newtab');
        state.errorLink = document.getElementById('drawer-error-link');
    }
    
    // 显示状态切换
    function showState(view) {
        const views = {
            loading: state.loading,
            article: state.article,
            error: state.error
        };
        
        Object.entries(views).forEach(([key, el]) => {
            if (!el) return;
            if (key === view) {
                el.classList.remove('hidden');
                if (key !== 'article') el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        });
    }
    
    // 打开抽屉
    async function openDrawer(url) {
        if (!state.drawer) initElements();
        if (!state.drawer) return;
        
        state.currentUrl = url;
        state.isOpen = true;
        
        // 显示抽屉
        state.overlay?.classList.remove('opacity-0', 'pointer-events-none');
        state.overlay?.classList.add('opacity-100', 'pointer-events-auto');
        state.drawer?.classList.remove('translate-x-full');
        state.drawer?.classList.add('translate-x-0');
        
        document.body.style.overflow = 'hidden';
        
        // 更新链接
        if (state.openNewtab) state.openNewtab.href = url;
        if (state.errorLink) state.errorLink.href = url;
        
        showState('loading');
        
        // 加载文章
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('加载失败');
            
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            
            const articleContent = doc.querySelector('.prose-custom');
            const articleMeta = doc.querySelector('header');
            
            let previewHTML = '';
            
            // 元信息
            if (articleMeta) {
                const metaContent = articleMeta.querySelector('.flex.flex-wrap.items-center');
                if (metaContent) {
                    previewHTML += `<div class="text-sm text-muted-foreground mb-6 pb-6 border-b border-border">${metaContent.innerHTML}</div>`;
                }
            }
            
            // 正文内容
            if (articleContent) {
                previewHTML += `<div class="prose-custom">${articleContent.innerHTML}</div>`;
            } else {
                previewHTML += '<p class="text-muted-foreground">无法提取文章内容</p>';
            }
            
            // 阅读全文链接
            previewHTML += `
                <div class="mt-10 pt-6 border-t border-border text-center">
                    <a href="${url}" target="_blank" class="inline-flex items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                        <span>阅读全文</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </a>
                </div>
            `;
            
            if (state.article) state.article.innerHTML = previewHTML;
            showState('article');
        } catch (error) {
            console.error('加载文章失败:', error);
            showState('error');
        }
    }
    
    // 关闭抽屉
    function closeDrawer() {
        if (!state.drawer || !state.isOpen) return;
        
        state.drawer?.classList.remove('translate-x-0');
        state.drawer?.classList.add('translate-x-full');
        state.overlay?.classList.remove('opacity-100', 'pointer-events-auto');
        state.overlay?.classList.add('opacity-0', 'pointer-events-none');
        
        state.isOpen = false;
        document.body.style.overflow = '';
        
        setTimeout(() => {
            if (state.article) state.article.innerHTML = '';
        }, 300);
    }
    
    // 事件委托处理器 - 在捕获阶段处理以优先于 Swup
    function handleLinkClick(e) {
        const link = e.target.closest('a[href^="/blog/"]');
        if (!link) return;
        
        const href = link.getAttribute('href');
        if (!href || href.includes('#')) return;
        
        // 检查是否在文章内容区内
        const articleContent = link.closest('.prose-custom');
        if (!articleContent) return;
        
        // 检查是否按住了 Ctrl/Cmd 或 Shift
        if (e.ctrlKey || e.metaKey || e.shiftKey) return;
        
        // 阻止默认行为和 Swup 处理
        e.preventDefault();
        e.stopPropagation();
        
        openDrawer(href);
    }
    
    // 绑定事件
    function bindEvents() {
        // 使用事件委托，在 document 级别捕获点击
        // 这样可以确保在 Swup 之前处理
        document.addEventListener('click', handleLinkClick, true);
        
        // 抽屉控制
        state.closeBtn?.addEventListener('click', closeDrawer);
        state.overlay?.addEventListener('click', closeDrawer);
        
        // ESC 关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && state.isOpen) {
                closeDrawer();
            }
        });
    }
    
    // 添加视觉提示
    function addVisualHints() {
        document.querySelectorAll('.prose-custom a[href^="/blog/"]').forEach(link => {
            const href = link.getAttribute('href');
            if (href.includes('#')) return;
            if (link.querySelector('.drawer-hint')) return;
            
            link.classList.add('inline-flex', 'items-center', 'gap-1');
            link.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 drawer-hint"><path d="m9 18 6-6-6-6"/></svg>`;
            link.title = "点击预览文章";
        });
    }
    
    // 初始化
    function init() {
        initElements();
        bindEvents();
        addVisualHints();
    }
    
    // 立即执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Swup 兼容
    if (window.SwupCompat) {
        window.SwupCompat.onPageView(() => {
            addVisualHints();
        });
    } else {
        document.addEventListener('astro:page-load', addVisualHints);
        document.addEventListener('swup:contentReplaced', addVisualHints);
    }
})();
</script>
