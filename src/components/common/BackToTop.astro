---
// src/components/common/BackToTop.astro
---

<button
        id="back-to-top"
        aria-label="返回顶部"
        class="fixed bottom-8 right-8 z-50 flex h-12 w-12 items-center justify-center rounded-full bg-white dark:bg-zinc-900 shadow-xl border border-gray-100 dark:border-zinc-800 transition-all duration-500 translate-y-20 opacity-0 hover:scale-110 active:scale-95 group invisible"
>
    <svg class="absolute h-full w-full -rotate-90 pointer-events-none">
        <circle
                id="progress-circle"
                cx="24"
                cy="24"
                r="20"
                stroke-width="3"
                stroke="currentColor"
                fill="transparent"
                class="text-indigo-600 dark:text-indigo-500 transition-all duration-100"
                style="stroke-dasharray: 125.66; stroke-dashoffset: 125.66;"
        ></circle>
    </svg>
    <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-gray-600 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
    >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
</button>

<style>
    /* 确保按钮在不支持 JS 的情况下隐藏 */
    #back-to-top.invisible {
        visibility: hidden;
    }
</style>

<script>
    /**
     * 初始化返回顶部逻辑
     * 使用 astro:page-load 确保在 View Transitions 跳转后依然有效
     */
    const initBackToTop = () => {
        const btn = document.getElementById('back-to-top');
        const circle = document.getElementById('progress-circle') as SVGCircleElement | null;

        // 圆周长 C = 2 * π * r (r=20) ≈ 125.66
        const circumference = 2 * Math.PI * 20;

        if (!btn || !circle) return;

        const updateUI = () => {
            const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollTop = window.scrollY;

            // 1. 更新进度环
            const progress = Math.min(scrollTop / scrollHeight, 1);
            const offset = circumference - progress * circumference;
            circle.style.strokeDashoffset = offset.toString();

            // 2. 控制显隐 (滚动 300px 后显示)
            if (scrollTop > 300) {
                btn.classList.remove('translate-y-20', 'opacity-0', 'invisible');
            } else {
                btn.classList.add('translate-y-20', 'opacity-0', 'invisible');
            }
        };

        // 绑定点击事件：平滑滚动到顶部
        btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

        // 监听滚动
        window.addEventListener('scroll', updateUI, { passive: true });

        // 初始执行一次
        updateUI();
    };

    // 适配 Astro View Transitions
    document.addEventListener('astro:page-load', initBackToTop);
</script>

