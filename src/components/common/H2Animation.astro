---
/**
 * @component H2Animation
 * @description H2 标题动画组件，滚动到视口时触发下划线动画
 * @features IntersectionObserver 优化、只触发一次、Swup 兼容
 * @usage 在 BaseLayout 中引用，自动为所有 .prose-custom h2 添加动画
 */
---

<script is:inline data-swup-ignore-script>
  (function() {
    let h2Observer = null;
    
    function initH2Animation() {
      // 清理旧的 observer
      if (h2Observer) {
        h2Observer.disconnect();
      }
      
      const h2Elements = document.querySelectorAll('.prose-custom h2');
      if (h2Elements.length === 0) return;

      h2Observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            // 只触发一次动画
            h2Observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.2,
        rootMargin: '-50px 0px'
      });

      h2Elements.forEach(h2 => h2Observer.observe(h2));
    }

    // 初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initH2Animation);
    } else {
      initH2Animation();
    }

    // 使用 SwupCompat 统一处理页面切换
    if (window.SwupCompat) {
      window.SwupCompat.onPageView(initH2Animation);
    } else {
      // 降级处理
      document.addEventListener('astro:page-load', initH2Animation);
      document.addEventListener('swup:enable', () => {
        window.swup?.hooks?.on('page:view', initH2Animation);
      });
    }
  })();
</script>
