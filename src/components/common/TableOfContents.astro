---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings = [] } = Astro.props;

// 只显示 H2 和 H3
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <nav class="text-sm">
    <ul class="space-y-1.5 border-l border-border" id="toc-list">
      {filteredHeadings.map((heading) => (
        <li
          class="toc-item"
          style={`margin-left: -1px; border-left: 1px solid transparent; padding-left: ${(heading.depth - 2) * 0.75 + 0.75}rem; transition: border-color 0.2s;`}
        >
          <a
            href={`#${heading.slug}`}
            class="block py-1 text-sm text-muted-foreground hover:text-foreground transition-colors toc-link"
            data-slug={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script is:inline>
  (function() {
    function initTOC() {
      const tocItems = document.querySelectorAll('.toc-item');
      const tocLinks = document.querySelectorAll('.toc-link');
      const headings = Array.from(document.querySelectorAll('article h2, article h3'));
      
      if (headings.length === 0) return;
      
      const visibleHeadings = new Map();
      
      // 使用 IntersectionObserver 优化性能
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          visibleHeadings.set(entry.target.id, entry.isIntersecting);
        });
        
        const activeEntries = Array.from(visibleHeadings.entries()).filter(([_, visible]) => visible);
        
        let activeId = '';
        
        if (activeEntries.length > 0) {
          activeId = activeEntries[0][0];
        } else {
          const scrollY = window.scrollY + 100;
          activeId = headings
            .filter(h => h.offsetTop <= scrollY)
            .pop()?.id || '';
        }
        
        if (activeId) {
          tocItems.forEach((item, index) => {
            const link = tocLinks[index];
            const linkSlug = link?.getAttribute('data-slug');
            if (linkSlug === activeId) {
              item.style.borderLeftColor = 'currentColor';
              link?.classList.add('font-medium');
              link?.classList.remove('text-muted-foreground');
              link?.classList.add('text-foreground');
              
              // 只在必要时滚动目录项到视图内
              const itemRect = item.getBoundingClientRect();
              const container = item.parentElement?.parentElement;
              if (container) {
                const containerRect = container.getBoundingClientRect();
                if (itemRect.top < containerRect.top || itemRect.bottom > containerRect.bottom) {
                  item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
              }
            } else {
              item.style.borderLeftColor = 'transparent';
              link?.classList.remove('font-medium');
              link?.classList.add('text-muted-foreground');
              link?.classList.remove('text-foreground');
            }
          });
        }
      }, {
        rootMargin: '-10% 0px -70% 0px',
        threshold: 0
      });
      
      headings.forEach(h => observer.observe(h));
    }
    
    // 延迟初始化，确保页面完全加载
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTOC);
    } else {
      initTOC();
    }
    
    // 兼容 Astro View Transitions
    document.addEventListener('astro:page-load', initTOC);
  })();
</script>
