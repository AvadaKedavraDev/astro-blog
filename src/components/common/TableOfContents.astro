---
import type { MarkdownHeading } from 'astro';
interface Props {
    headings: MarkdownHeading[];
}
const { headings = [] } = Astro.props;

// 过滤掉 H1 和 H6
const filteredHeadings = headings.filter((h) => h.depth > 1 && h.depth <= 5);
---

<nav id="toc-container" class="p-4 bg-white/50 dark:bg-zinc-900/50 rounded-xl border border-gray-100 dark:border-zinc-800 sticky top-24 transition-all overflow-y-auto max-h-[calc(100vh-120px)] custom-scrollbar">
    <div class="flex items-center gap-2 mb-4 text-indigo-600 dark:text-indigo-400">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
        <span class="font-bold text-sm uppercase tracking-wider text-slate-900 dark:text-white">目录内容</span>
    </div>

    <ul class="relative space-y-1 border-l border-slate-200 dark:border-slate-800 ml-1">
        {filteredHeadings.map((heading) => (
                <li
                        class="toc-item group"
                        style={`padding-left: ${(heading.depth - 2) * 0.75}rem`}
                >
                    <a
                            href={`#${heading.slug}`}
                            class="block py-1.5 px-3 -ml-[1px] border-l-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all duration-200 text-[13px] leading-tight"
                            data-slug={heading.slug}
                    >
                        {heading.text}
                    </a>
                </li>
        ))}
    </ul>
</nav>

<style>
    @reference "@/styles/global.css";
    /* 极致平滑滚动 */
    :global(html) {
        scroll-behavior: smooth;
    }

    /* 激活状态 */
    .toc-item.active a {
        @apply border-indigo-500 text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20 font-semibold;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { @apply bg-slate-200 dark:bg-slate-800 rounded; }
</style>

<script>
    function initTOC() {
        const tocLinks = document.querySelectorAll('.toc-item');
        const headings = Array.from(document.querySelectorAll('article h2, article h3, article h4, article h5'));

        if (headings.length === 0) return;

        // 用于记录每个标题的可见状态
        const visibleHeadings = new Map();

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                // 更新 Map 中标题的可见性（true 为在视口内，false 为不在）
                visibleHeadings.set(entry.target.id, entry.isIntersecting);

                // 核心逻辑：找到当前所有可见标题中，在页面位置最靠上的那一个
                const activeId = Array.from(visibleHeadings.entries())
                    .filter(([_, isVisible]) => isVisible)
                    .map(([id]) => {
                        const el = document.getElementById(id);
                        return { id, top: el ? el.getBoundingClientRect().top : Infinity };
                    })
                    .sort((a, b) => a.top - b.top)[0]?.id;

                if (activeId) {
                    updateActiveState(activeId);
                }
            });
        }, {
            // 这里的 rootMargin 决定了触发高亮的“活跃区”
            // 建议只保留顶部 20% 的区域作为判定区，能极大缓解跳跃感
            rootMargin: '-100px 0px -75% 0px',
            threshold: 0
        });

        headings.forEach((h) => observer.observe(h));

        function updateActiveState(slug: string) {
            tocLinks.forEach((link) => {
                const anchor = link.querySelector('a');
                const isActive = anchor?.getAttribute('data-slug') === slug;

                if (isActive) {
                    link.classList.add('active');
                    // 只有当激活项不在目录可视区时才滚动，防止目录本身抖动
                    link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    link.classList.remove('active');
                }
            });
        }
    }

    document.addEventListener('astro:page-load', initTOC);
</script>