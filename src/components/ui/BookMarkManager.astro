---
// 工具箱组件
interface Link {
    name: string;
    url: string;
    desc?: string;
}

interface Category {
    title: string;
    icon: string;
    links: Link[];
}

interface Props {
    categories: Category[];
}

const { categories } = Astro.props;

// 获取网站 hostname 作为种子
function getHostname(url: string): string {
    try {
        return new URL(url).hostname;
    } catch {
        return url;
    }
}

// 获取网站首字母
function getInitial(name: string): string {
    return name.charAt(0).toUpperCase();
}

// 生成颜色（基于字符串）
function generateColor(str: string): string {
    const colors = [
        '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e',
        '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6',
        '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'
    ];
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}
---

<div class="bookmark-container w-full antialiased">
    <!-- Search -->
    <div class="relative max-w-xl mx-auto mb-16">
        <div class="relative">
            <input
                type="text"
                id="nav-search-input"
                placeholder="搜索工具和资源... 按 / 快速聚焦"
                class="input-base w-full rounded-2xl!"
            />
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-muted-foreground bg-muted px-2 py-1 rounded">
                /
            </div>
        </div>
    </div>

    <!-- Categories -->
    <div class="space-y-16">
        {categories.map((category) => (
            <section class="bookmark-section scroll-mt-28" id={category.title}>
                <!-- Category Header -->
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-2xl">{category.icon}</span>
                    <h2 class="text-lg font-semibold text-foreground">{category.title}</h2>
                    <div class="flex-1 divider-subtle"></div>
                </div>

                <!-- Links Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {category.links.map((link) => {
                        const hostname = getHostname(link.url);
                        const initial = getInitial(link.name);
                        const bgColor = generateColor(hostname);
                        return (
                            <a
                                href={link.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="bookmark-card group flex items-start gap-4 p-5 card-base no-underline! hover:-translate-y-0.5"
                            >
                                <!-- Favicon -->
                                <div 
                                    class="w-10 h-10 rounded-lg bg-muted flex items-center justify-center shrink-0 overflow-hidden favicon-container"
                                    data-hostname={hostname}
                                    data-initial={initial}
                                    data-color={bgColor}
                                >
                                    <img
                                        src={`https://www.google.com/s2/favicons?domain=${link.url}&sz=128`}
                                        alt=""
                                        class="w-6 h-6 object-contain favicon-img"
                                        loading="lazy"
                                        onerror="this.style.display='none'; this.parentElement.classList.add('show-fallback');"
                                    />
                                    <!-- 备用图标 - 首字母 -->
                                    <div 
                                        class="favicon-fallback w-full h-full flex items-center justify-center text-white text-sm font-bold" 
                                        style={`background-color: ${bgColor}`}
                                    >
                                        {initial}
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-medium text-foreground group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors truncate">
                                            {link.name}
                                        </h3>
                                        <svg class="w-3 h-3 text-muted-foreground opacity-0 -translate-x-1 group-hover:opacity-100 group-hover:translate-x-0 transition-all shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </div>
                                    <p class="text-xs text-muted-foreground mt-0.5 truncate">
                                        {hostname}
                                    </p>
                                    {link.desc && (
                                        <p class="text-sm text-muted-foreground mt-2 line-clamp-2">
                                            {link.desc}
                                        </p>
                                    )}
                                </div>
                            </a>
                        );
                    })}
                </div>
            </section>
        ))}
    </div>

    <!-- No Results -->
    <div id="no-results" class="hidden py-24 text-center">
        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-muted text-muted-foreground mb-4 text-xl">
            ?
        </div>
        <h3 class="text-foreground font-medium mb-1">未找到相关结果</h3>
        <p class="text-sm text-muted-foreground">试试其他关键词，或按 ESC 重置</p>
    </div>
</div>

<style>
    /* 当 favicon 加载失败时显示备用图标 */
    .favicon-container.show-fallback .favicon-fallback {
        display: flex !important;
    }
</style>

<script is:inline>
    (function() {
        function initBookmarkManager() {
            const searchInput = document.getElementById('nav-search-input');
            const cards = document.querySelectorAll('.bookmark-card');
            const sections = document.querySelectorAll('.bookmark-section');
            const noResults = document.getElementById('no-results');

            if (!searchInput) return;

            // 快捷键：/ 聚焦，ESC 清空
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && document.activeElement !== searchInput) {
                    e.preventDefault();
                    searchInput.focus();
                }
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                    searchInput.blur();
                }
            });

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                let visibleCount = 0;

                sections.forEach((section) => {
                    const sectionCards = section.querySelectorAll('.bookmark-card');
                    let sectionHasMatch = false;

                    sectionCards.forEach((card) => {
                        const content = card.textContent?.toLowerCase() || '';
                        const isMatch = content.includes(query);
                        card.style.display = isMatch ? 'flex' : 'none';
                        if (isMatch) {
                            sectionHasMatch = true;
                            visibleCount++;
                        }
                    });

                    section.style.display = sectionHasMatch ? 'block' : 'none';
                });

                if (noResults) {
                    noResults.classList.toggle('hidden', visibleCount > 0 || query === '');
                }
            });
        }

        initBookmarkManager();
        document.addEventListener('astro:page-load', initBookmarkManager);
    })();
</script>
