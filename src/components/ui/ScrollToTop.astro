---
/**
 * @component ScrollToTop
 * @description 返回顶部按钮组件，滚动超过300px时显示
 * @features requestAnimationFrame 优化、平滑滚动、Swup 兼容
 * @usage 在 BaseLayout 中引用
 */
import { Icon } from "astro-icon/components";
---

<button
  id="scroll-to-top"
  class="fixed bottom-8 right-8 p-3 rounded-full card-base z-50
         opacity-0 translate-y-4 pointer-events-none transition-all duration-300
         hover:scale-110 !hover:shadow-lg group"
  aria-label="返回顶部"
>
  <Icon 
    name="lucide:arrow-up" 
    class="w-5 h-5 transition-transform duration-300 group-hover:-translate-y-1 group-hover:animate-bounce" 
  />
</button>

<script is:inline data-swup-ignore-script>
  (function() {
    function initScrollToTop() {
      const button = document.getElementById('scroll-to-top');
      if (!button) return;
      
      // 移除旧的事件监听器（通过克隆）
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);
      
      let ticking = false;
      
      function toggleVisibility() {
        const scrollTop = window.scrollY;
        if (scrollTop > 300) {
          newButton.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
          newButton.classList.add('opacity-100', 'translate-y-0');
        } else {
          newButton.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
          newButton.classList.remove('opacity-100', 'translate-y-0');
        }
        ticking = false;
      }
      
      window.addEventListener('scroll', function() {
        if (!ticking) {
          requestAnimationFrame(toggleVisibility);
          ticking = true;
        }
      }, { passive: true });
      
      newButton.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      
      // 初始检查
      toggleVisibility();
    }
    
    // 页面加载时初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initScrollToTop);
    } else {
      initScrollToTop();
    }
    
    // Swup 兼容 - 使用统一的 SwupCompat
    if (window.SwupCompat) {
      window.SwupCompat.onPageView(initScrollToTop);
    } else {
      // 降级处理
      document.addEventListener('swup:contentReplaced', initScrollToTop);
      document.addEventListener('astro:page-load', initScrollToTop);
    }
  })();
</script>
