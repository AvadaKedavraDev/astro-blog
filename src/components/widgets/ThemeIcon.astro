---
/**
 * @component ThemeIcon
 * @description 深浅色模式切换按钮
 * @props size - 按钮尺寸 sm/md/lg（默认md）
 * @props variant - 显示样式 icon/button（默认icon）
 * @features 全局单例模式、localStorage 持久化、触觉反馈、Swup 兼容
 * @usage 在 Navigation 组件中使用
 */
// 暗黑切换组件
import {Icon} from "astro-icon/components";

interface Props {
    size?: "sm" | "md" | "lg";
    variant?: "icon" | "button";
}

const {size = "md", variant = "icon"} = Astro.props;

const sizeClasses = {
    sm: "w-8 h-8",
    md: "w-10 h-10",
    lg: "w-12 h-12",
};

const iconSizes = {
    sm: "w-4 h-4",
    md: "w-5 h-5",
    lg: "w-6 h-6",
};
---

<button
        data-theme-toggle
        class:list={[
            sizeClasses[size],
            "rounded-full flex items-center justify-center",
            "text-muted-foreground hover:text-foreground hover:bg-muted",
            "transition-all duration-200 ease-out",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",
            "group",
            variant === "button" && "px-4 gap-2 w-auto",
        ]}
        aria-label="切换主题"
        type="button"
>
    {/* Sun - 暗黑模式下显示 */}
    <Icon
            name="lucide:sun"
            class:list={[
                "sun-icon",
                iconSizes[size],
                "hidden dark:block",
                "transition-transform duration-500 ease-spring",
                "group-hover:rotate-45",
            ]}
            aria-hidden="true"
    />

    <Icon
            name="lucide:moon"
            class:list={[
                "moon-icon",
                iconSizes[size],
                "block dark:hidden",
                "transition-transform duration-500 ease-spring",
                "group-hover:-rotate-12",
            ]}
            aria-hidden="true"
    />

    {
        variant === "button" && (
                    <span class="text-sm font-medium select-none">
                <span class="dark:hidden">深色模式</span>
                <span class="hidden dark:block">浅色模式</span>
            </span>
        )
    }
</button>

{/* 主题管理逻辑 - 使用全局单例模式 */}
<script>
    // 类型定义（在 .astro 文件中可省略，但有助于 IDE 提示）
    interface ThemeManager {
        initialized: boolean;
        toggle: () => void;
        init: () => void;
        destroy: () => void;
    }

    // 全局单例，确保即使脚本被多次执行（View Transitions）也不会重复绑定
    if (!window.themeManager) {
        window.themeManager = {
            initialized: false,

            toggle() {
                const isDark = document.documentElement.classList.toggle("dark");
                const theme = isDark ? "dark" : "light";

                // 持久化
                localStorage.setItem("theme", theme);

                // 触觉反馈（移动端）
                if (window.navigator?.vibrate) {
                    navigator.vibrate(10);
                }

                // 触发自定义事件供其他组件监听
                window.dispatchEvent(
                    new CustomEvent("themechange", {
                        detail: {theme, isDark},
                    })
                );
            },

            init() {
                if (this.initialized) return;

                // 使用事件委托，无论按钮何时被添加到 DOM 都有效
                this.handleClick = (e: MouseEvent) => {
                    const btn = (e.target as HTMLElement).closest(
                        "[data-theme-toggle]"
                    );
                    if (!btn) return;

                    e.preventDefault();
                    this.toggle();
                };

                this.handleKeydown = (e: KeyboardEvent) => {
                    if (e.key !== "Enter" && e.key !== " ") return;

                    const btn = (e.target as HTMLElement).closest(
                        "[data-theme-toggle]"
                    );
                    if (!btn) return;

                    e.preventDefault();
                    this.toggle();
                };

                this.handleStorage = (e: StorageEvent) => {
                    if (e.key !== "theme" || !e.newValue) return;

                    const isDark = e.newValue === "dark";
                    document.documentElement.classList.toggle("dark", isDark);
                };

                // 绑定事件
                document.addEventListener("click", this.handleClick);
                document.addEventListener("keydown", this.handleKeydown);
                window.addEventListener("storage", this.handleStorage);

                this.initialized = true;
            },

            destroy() {
                if (!this.initialized) return;

                document.removeEventListener("click", this.handleClick);
                document.removeEventListener("keydown", this.handleKeydown);
                window.removeEventListener("storage", this.handleStorage);

                this.initialized = false;
            },
        } as ThemeManager & {
            handleClick?: (e: MouseEvent) => void;
            handleKeydown?: (e: KeyboardEvent) => void;
            handleStorage?: (e: StorageEvent) => void;
        };
    }

    // 立即初始化
    window.themeManager.init();

    // Astro View Transitions 生命周期兼容
    // 注意：如果使用 View Transitions，需要在页面切换后重新确认初始化状态
    document.addEventListener("astro:page-load", () => {
        window.themeManager.init();
    });

    // 清理（可选，防止内存泄漏）
    document.addEventListener("astro:before-swap", () => {
        // 实际上不需要 destroy，因为我们希望事件委托一直生效
        // 但如果需要完全清理，可以在这里调用
    });
</script>