---
import { Icon } from "astro-icon/components";

interface Props {
  size?: "sm" | "md" | "lg";
  variant?: "icon" | "button";
}

const { size = "md", variant = "icon" } = Astro.props;

const sizeClasses = {
  sm: "w-8 h-8",
  md: "w-10 h-10",
  lg: "w-12 h-12",
};

const iconSizes = {
  sm: "w-4 h-4",
  md: "w-5 h-5",
  lg: "w-6 h-6",
};
---

<button
  id="theme-toggle"
  class:list={[
    sizeClasses[size],
    "rounded-full flex items-center justify-center text-muted-foreground hover:text-foreground hover:bg-muted transition-all group",
    variant === 'button' && 'px-4 gap-2'
  ]}
  aria-label="切换主题"
>
  {/* Sun Icon - 在暗黑模式下显示 */}
  <Icon 
    name="lucide:sun" 
    class:list={["sun-icon", iconSizes[size], "hidden dark:block transition-transform duration-500 group-hover:rotate-45"]} 
  />
  
  {/* Moon Icon - 在浅色模式下显示 */}
  <Icon 
    name="lucide:moon" 
    class:list={["moon-icon", iconSizes[size], "block dark:hidden transition-transform duration-500 group-hover:-rotate-12"]} 
  />
  
  {variant === "button" && (
    <span class="text-sm font-medium">
      <span class="dark:hidden">深色</span>
      <span class="hidden dark:block">浅色</span>
    </span>
  )}
</button>

{/* 主题初始化脚本 - 在页面加载前执行 */}
<script is:inline>
  // 立即执行，避免闪烁
  (function() {
    const theme = localStorage.getItem('theme') || 
      (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  })();
</script>

{/* 主题切换事件处理 */}
<script>
  function initThemeToggle() {
    const toggle = document.getElementById('theme-toggle');
    if (!toggle) return;
    
    // 移除旧的事件监听器（如果存在）
    const newToggle = toggle.cloneNode(true);
    toggle.parentNode?.replaceChild(newToggle, toggle);
    
    // 添加新的事件监听器
    newToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
  }
  
  // 初始化
  initThemeToggle();
  
  // 兼容 Astro View Transitions
  document.addEventListener('astro:page-load', initThemeToggle);
  document.addEventListener('astro:after-swap', initThemeToggle);
  
  // 兼容 Swup
  document.addEventListener('swup:enable', () => {
    window.swup?.hooks?.on('page:view', initThemeToggle);
  });
</script>
