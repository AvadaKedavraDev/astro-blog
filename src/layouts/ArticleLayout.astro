---
import BaseLayout from "@layouts/BaseLayout.astro";
import ArticleNavigation from "@components/article/ArticleNavigation.astro";
import TableOfContents from "@components/common/TableOfContents.astro";
import RelatedPosts from "@components/common/RelatedPosts.astro";

import { getAdjacentPosts } from "@lib/post";
import { getCollection, type CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";

interface Props { post: CollectionEntry<'blog'>, headings: MarkdownHeading[]; }

const { post, headings } = Astro.props;
const { title, description, pubDate, author = "匿名作者", tags = [], readingTime, coverImage } = post.data;

const { prev, next } = await getAdjacentPosts(post.slug);
const formattedDate = pubDate?.toLocaleDateString("zh-CN", { year: 'numeric', month: 'long', day: 'numeric' });

const allPosts = await getCollection('blog');
---

<BaseLayout {title} {description} ogImage={coverImage} mainClass="w-full px-0 py-0">
  <div class="relative w-full min-h-screen">

    <aside
        id="related-posts-sidebar"
        class="fixed top-19 left-0 z-50 w-72 bg-slate-50/80 dark:bg-slate-900/40 border-r border-slate-200 dark:border-slate-800 backdrop-blur-md transition-transform duration-300 xl:block"
    >
      <button
          id="toggleSidebar"
          class="absolute top-24 -right-10 w-10 h-10 bg-indigo-600 text-white rounded-r-xl flex items-center justify-center xl:hidden shadow-lg shadow-indigo-500/20"
          aria-label="Toggle Sidebar"
      >
        <svg id="toggleIcon" class="w-5 h-5 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6" />
        </svg>
      </button>

      <div class="h-full overflow-y-auto pt-24 pb-10 px-6 custom-scrollbar">
        <RelatedPosts relatedPosts={allPosts}/>
      </div>
    </aside>

    <main class="w-full xl:pl-72 transition-all duration-300">
      <div class="max-w-[1200px] mx-auto flex flex-col min-[1300px]:flex-row gap-8 lg:gap-12 py-8 px-4 sm:px-6 lg:px-8">

        <article class="flex-1 min-w-0 py-8">
          <header class="mb-12 text-center lg:text-left">
            {tags.length > 0 && (
                <div class="flex justify-center lg:justify-start gap-3 mb-4">
                  {tags.map(tag => (
                      <span class="text-xs font-bold tracking-widest uppercase text-indigo-600 dark:text-indigo-400">
                    #{tag}
                  </span>
                  ))}
                </div>
            )}

            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 dark:text-slate-100 mb-6 tracking-tight leading-tight">
              {title}
            </h1>

            <div class="flex items-center justify-center lg:justify-start text-sm text-gray-500 dark:text-gray-400 space-x-3 font-medium">
              <span>{author}</span>
              {pubDate && <time datetime={pubDate.toISOString()}>· {formattedDate}</time>}
              {readingTime && <span>· 约 {readingTime} 分钟</span>}
            </div>
          </header>

          {coverImage && (
              <figure class="mb-14">
                <img
                    src={coverImage}
                    alt={title}
                    class="w-full aspect-[21/9] object-cover rounded-2xl shadow-xl border border-gray-100 dark:border-gray-800"
                    loading="eager"
                />
              </figure>
          )}

          <div class="prose prose-custom max-w-none dark:prose-invert">
            <slot />
          </div>

          <footer class="mt-20">
            <ArticleNavigation
                prevArticle={prev ? { title: prev.data.title, slug: prev.slug } : undefined}
                nextArticle={next ? { title: next.data.title, slug: next.slug } : undefined}
            />
          </footer>
        </article>

        <aside class="hidden min-[1300px]:block w-64 sticky top-24 self-start py-8">
          <div class="bg-white/50 dark:bg-white/5 p-4 rounded-2xl border border-slate-100 dark:border-white/5">
            <TableOfContents {headings} />
          </div>
        </aside>

      </div>
    </main>
  </div>

  <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-40 hidden backdrop-blur-sm xl:hidden"></div>
</BaseLayout>

<style is:global>
  @reference "../styles/global.css";


  @media (min-width: 1280px) {
    #related-posts-sidebar {
      transform: translateX(0) !important;
    }
  }

  html {
    scroll-behavior: smooth;
    scroll-padding-top: 100px;
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-slate-200 dark:bg-slate-800 rounded-full;
  }

  .prose-custom {
    --tw-prose-headings: var(--color-slate-900);
    --tw-prose-links: var(--color-indigo-600);
  }

  .dark .prose-custom {
    --tw-prose-headings: var(--color-slate-100);
    --tw-prose-links: var(--color-indigo-400);
  }

  .prose-custom :where(h1, h2, h3, h4, h5) {
    scroll-margin-top: 100px;
  }
</style>

<script>
  function setupSidebar() {
    const sidebar = document.getElementById('related-posts-sidebar');
    const btn = document.getElementById('toggleSidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const icon = document.getElementById('toggleIcon');

    if (!sidebar || !btn || !overlay) return;

    // 每次切换页面时，先移除可能存在的过渡限制，重新计算显示状态
    if (window.innerWidth >= 1280) {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.add('hidden');
    }

    const toggle = () => {
      const isHidden = sidebar.classList.contains('-translate-x-full');
      if (isHidden) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        icon?.classList.add('rotate-180');
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        icon?.classList.remove('rotate-180');
      }
    };

    btn.onclick = (e) => {
      e.stopPropagation();
      toggle();
    };

    overlay.onclick = toggle;

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1280) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.add('hidden');
      } else {
        sidebar.classList.add('-translate-x-full');
      }
    });
  }

  setupSidebar();
  document.addEventListener('astro:page-load', setupSidebar);
  document.addEventListener('swup:content:replace', setupSidebar);
</script>