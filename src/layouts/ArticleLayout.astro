---
import BaseLayout from "@layouts/BaseLayout.astro";
import ReadingProgress from "@components/ui/ReadingProgress.astro";
import TableOfContents from "@components/common/TableOfContents.astro";
import ArticleNavigation from "@components/article/ArticleNavigation.astro";
import RelatedPostsByTag from "@components/article/RelatedPostsByTag.astro";

import { getAdjacentPosts, getRelatedPostsByTags } from "@lib/post";
import { type CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";

interface Props {
    post: CollectionEntry<'blog'>;
    headings: MarkdownHeading[];
}

const { post, headings } = Astro.props;
const { title, description, pubDate, author = "Moonpeak", tags = [], readingTime, coverImage } = post.data;

// 获取相邻文章
const { prev, next } = await getAdjacentPosts(post.slug);

// 获取同标签文章
const relatedPosts = await getRelatedPostsByTags(post.slug, tags, 8);

// 判断是否有目录
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
const hasTOC = tocHeadings.length > 0;

const formattedDate = pubDate?.toLocaleDateString("zh-CN", {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});
---

<BaseLayout title={title} description={description} ogImage={coverImage}>
    <ReadingProgress />
    
    {/* 文章页面整体背景 - 比默认背景稍深，突出 card */}
    <div class="min-h-screen bg-[#f5f5f5] dark:bg-[#0f0f0f] transition-colors duration-300">
        
        {/* Hero Header - 在 card 外部 */}
        <header class="pt-24 pb-8 px-4 sm:px-6">
            <div class="max-w-7xl mx-auto">
                <!-- Back Link -->
                <a 
                    href="/blog" 
                    class="inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors mb-4"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    返回文章列表
                </a>
                
                <!-- Title 区域 -->
                <div class="max-w-4xl">
                    <!-- Tags -->
                    {tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mb-3">
                            {tags.map(tag => (
                                <a 
                                    href={`/tags/${tag}/`}
                                    class="px-2.5 py-0.5 text-xs font-medium rounded-md bg-muted/50 text-muted-foreground hover:bg-foreground hover:text-background transition-colors"
                                >
                                    {tag}
                                </a>
                            ))}
                        </div>
                    )}
                    
                    <!-- Title -->
                    <h1 class="text-xl md:text-2xl lg:text-3xl font-bold tracking-tight text-foreground mb-4 leading-tight">
                        {title}
                    </h1>
                    
                    <!-- Meta Info -->
                    <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                {author.charAt(0)}
                            </div>
                            <span class="font-medium text-foreground">{author}</span>
                        </div>
                        <span class="text-border">|</span>
                        <time datetime={pubDate.toISOString()}>{formattedDate}</time>
                        {readingTime && (
                            <>
                                <span class="text-border">|</span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    {readingTime} 分钟
                                </span>
                            </>
                        )}
                    </div>
                </div>
            </div>
        </header>
        
        {/* Cover Image - 在 card 外部 */}
        {coverImage && (
            <div class="px-4 sm:px-6 mb-6">
                <div class="max-w-7xl mx-auto">
                    <div class="max-w-4xl">
                        <img
                            src={coverImage}
                            alt={title}
                            class="w-full aspect-[2.5/1] object-cover rounded-xl shadow-sm"
                        />
                    </div>
                </div>
            </div>
        )}
        
        {/* Main Content Area - 三栏 Card 布局 */}
        <div class="px-4 sm:px-6 pb-16">
            <div class="max-w-7xl mx-auto">
                <div class="flex gap-4 lg:gap-5">
                    
                    {/* ========== 左侧边栏 - 相关文章 Card ========== */}
                    <aside 
                        id="left-sidebar"
                        class:list={[
                            "hidden lg:block shrink-0 transition-all duration-300 ease-out",
                            relatedPosts.length > 0 ? "w-64 opacity-100" : "w-0 opacity-0 overflow-hidden"
                        ]}
                    >
                        <div class="sticky top-20 space-y-4">
                            
                            {/* 相关文章 Card */}
                            <div class="bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                {/* Card Header */}
                                <div class="px-4 py-3 border-b border-border bg-muted/30 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        <span class="text-sm font-semibold text-foreground">相关文章</span>
                                    </div>
                                    <button 
                                        id="toggle-left-sidebar"
                                        class="p-1 rounded hover:bg-muted text-muted-foreground hover:text-foreground transition-colors"
                                        aria-label="收起"
                                        title="收起侧边栏"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                    </button>
                                </div>
                                {/* Card Body */}
                                <div class="p-3">
                                    <RelatedPostsByTag posts={relatedPosts} currentTags={tags} />
                                </div>
                            </div>
                            
                            {/* 可以添加更多 Card，比如：标签云 */}
                            {tags.length > 0 && (
                                <div class="bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                    <div class="px-4 py-3 border-b border-border bg-muted/30">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                            </svg>
                                            <span class="text-sm font-semibold text-foreground">文章标签</span>
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <div class="flex flex-wrap gap-1.5">
                                            {tags.map(tag => (
                                                <a 
                                                    href={`/tags/${tag}/`}
                                                    class="px-2 py-1 text-xs rounded-md bg-muted/50 text-muted-foreground hover:bg-indigo-50 hover:text-indigo-600 dark:hover:bg-indigo-950/30 dark:hover:text-indigo-400 transition-colors"
                                                >
                                                    {tag}
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                        </div>
                    </aside>
                    
                    {/* 左侧展开按钮 - 收起时显示在左侧边缘 */}
                    {relatedPosts.length > 0 && (
                        <button
                            id="expand-left-sidebar"
                            class="hidden flex-col items-center gap-1 fixed left-0 top-1/2 -translate-y-1/2 z-40 px-2 py-3 rounded-r-lg bg-card border border-l-0 border-border/80 dark:border-border shadow-lg transition-all duration-300 hover:pl-3"
                            aria-label="展开相关文章"
                            title="相关文章"
                        >
                            <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            <span class="text-[10px] text-muted-foreground writing-vertical">相关文章</span>
                        </button>
                    )}
                    
                    {/* ========== 中间主内容 - 文章 Card ========== */}
                    <main class="flex-1 min-w-0">
                        <article class="bg-background rounded-xl shadow-sm border border-border min-h-[600px]">
                            {/* 文章内容区 */}
                            <div class="p-6 md:p-8 lg:p-10">
                                <div class="prose-custom max-w-none">
                                    <slot />
                                </div>
                            </div>
                            
                            {/* 分隔线 */}
                            <div class="border-t border-border"></div>
                            
                            {/* 文章底部导航 */}
                            <div class="p-6 md:p-8">
                                <ArticleNavigation
                                    prevArticle={prev ? { title: prev.data.title, slug: prev.slug } : undefined}
                                    nextArticle={next ? { title: next.data.title, slug: next.slug } : undefined}
                                />
                            </div>
                        </article>
                    </main>
                    
                    {/* ========== 右侧边栏 - 目录 Card ========== */}
                    {hasTOC && (
                        <aside 
                            id="right-sidebar"
                            class="hidden xl:block w-56 shrink-0"
                        >
                            <div class="sticky top-20">
                                {/* 目录 Card */}
                                <div class="bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                    {/* Card Header */}
                                    <div class="px-4 py-3 border-b border-border bg-muted/30 flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                                            </svg>
                                            <span class="text-sm font-semibold text-foreground">目录</span>
                                        </div>
                                        <button 
                                            id="toggle-right-sidebar"
                                            class="p-1 rounded hover:bg-muted text-muted-foreground hover:text-foreground transition-colors"
                                            aria-label="收起"
                                            title="收起目录"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </button>
                                    </div>
                                    {/* Card Body */}
                                    <div class="p-3 max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar">
                                        <TableOfContents headings={tocHeadings} />
                                    </div>
                                </div>
                                
                                {/* 可以添加更多 Card，比如：工具 */}
                                <div class="mt-4 bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                    <div class="px-4 py-3 border-b border-border bg-muted/30">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                            </svg>
                                            <span class="text-sm font-semibold text-foreground">快捷操作</span>
                                        </div>
                                    </div>
                                    <div class="p-3 space-y-2">
                                        <button 
                                            onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                                            class="w-full flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted/50 rounded-lg transition-colors"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                            </svg>
                                            回到顶部
                                        </button>
                                        <a 
                                            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`}
                                            target="_blank"
                                            rel="noopener"
                                            class="w-full flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted/50 rounded-lg transition-colors"
                                        >
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                            </svg>
                                            分享文章
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    )}
                    
                    {/* 右侧展开按钮 - 收起时显示在右侧边缘 */}
                    {hasTOC && (
                        <button
                            id="expand-right-sidebar"
                            class="hidden flex-col items-center gap-1 fixed right-0 top-1/2 -translate-y-1/2 z-40 px-2 py-3 rounded-l-lg bg-card border border-r-0 border-border/80 dark:border-border shadow-lg transition-all duration-300 hover:pr-3"
                            aria-label="展开目录"
                            title="目录"
                        >
                            <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                            </svg>
                            <span class="text-[10px] text-muted-foreground writing-vertical">目录</span>
                        </button>
                    )}
                    
                </div>
            </div>
        </div>
        
        {/* Mobile: 底部相关文章 */}
        {relatedPosts.length > 0 && (
            <div class="lg:hidden px-4 sm:px-6 pb-12">
                <div class="bg-background rounded-xl shadow-sm border border-border p-4">
                    <div class="flex items-center gap-2 mb-4 pb-3 border-b border-border">
                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="text-sm font-semibold text-foreground">相关文章</span>
                    </div>
                    <div class="grid gap-3 sm:grid-cols-2">
                        {relatedPosts.slice(0, 4).map(post => (
                            <a
                                href={`/blog/${post.slug}/`}
                                class="group flex items-start gap-3 p-3 rounded-lg hover:bg-muted/50 transition-colors"
                            >
                                <div class="w-1 h-1 rounded-full bg-indigo-500 mt-2 shrink-0"></div>
                                <div>
                                    <div class="text-sm text-foreground group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-2">
                                        {post.data.title}
                                    </div>
                                    <div class="text-xs text-muted-foreground mt-1">
                                        {post.data.pubDate.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            </div>
        )}
    </div>
    
    {/* Sidebar Toggle Scripts */}
    <script is:inline>
        (function() {
            const leftSidebar = document.getElementById('left-sidebar');
            const leftToggle = document.getElementById('toggle-left-sidebar');
            const leftExpand = document.getElementById('expand-left-sidebar');
            
            const rightSidebar = document.getElementById('right-sidebar');
            const rightToggle = document.getElementById('toggle-right-sidebar');
            const rightExpand = document.getElementById('expand-right-sidebar');
            
            // 从 localStorage 读取状态
            const leftCollapsed = localStorage.getItem('left-sidebar-collapsed') === 'true';
            const rightCollapsed = localStorage.getItem('right-sidebar-collapsed') === 'true';
            
            // 初始化左侧边栏
            if (leftSidebar && leftCollapsed) {
                leftSidebar.style.width = '0';
                leftSidebar.style.opacity = '0';
                leftSidebar.style.marginRight = '-20px';
                if (leftExpand) {
                    leftExpand.style.display = 'flex';
                    leftExpand.style.opacity = '1';
                }
            }
            
            // 初始化右侧边栏
            if (rightSidebar && rightCollapsed) {
                rightSidebar.style.width = '0';
                rightSidebar.style.opacity = '0';
                rightSidebar.style.marginLeft = '-20px';
                if (rightExpand) {
                    rightExpand.style.display = 'flex';
                    rightExpand.style.opacity = '1';
                }
            }
            
            // 左侧边栏切换
            leftToggle?.addEventListener('click', () => {
                leftSidebar.style.width = '0';
                leftSidebar.style.opacity = '0';
                leftSidebar.style.marginRight = '-20px';
                localStorage.setItem('left-sidebar-collapsed', 'true');
                if (leftExpand) {
                    setTimeout(() => {
                        leftExpand.style.display = 'flex';
                        leftExpand.style.opacity = '1';
                    }, 300);
                }
            });
            
            leftExpand?.addEventListener('click', () => {
                leftSidebar.style.width = '16rem'; // w-64
                leftSidebar.style.opacity = '1';
                leftSidebar.style.marginRight = '0';
                leftExpand.style.opacity = '0';
                localStorage.setItem('left-sidebar-collapsed', 'false');
                setTimeout(() => { leftExpand.style.display = 'none'; }, 300);
            });
            
            // 右侧边栏切换
            rightToggle?.addEventListener('click', () => {
                rightSidebar.style.width = '0';
                rightSidebar.style.opacity = '0';
                rightSidebar.style.marginLeft = '-20px';
                localStorage.setItem('right-sidebar-collapsed', 'true');
                if (rightExpand) {
                    setTimeout(() => {
                        rightExpand.style.display = 'flex';
                        rightExpand.style.opacity = '1';
                    }, 300);
                }
            });
            
            rightExpand?.addEventListener('click', () => {
                rightSidebar.style.width = '14rem'; // w-56
                rightSidebar.style.opacity = '1';
                rightSidebar.style.marginLeft = '0';
                rightExpand.style.opacity = '0';
                localStorage.setItem('right-sidebar-collapsed', 'false');
                setTimeout(() => { rightExpand.style.display = 'none'; }, 300);
            });
        })();
    </script>
</BaseLayout>

<style>
    /* 垂直文字 */
    .writing-vertical {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        letter-spacing: 0.1em;
    }
</style>
