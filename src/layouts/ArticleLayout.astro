---
// src/layouts/ArticleLayout.astro
import BaseLayout from "@layouts/BaseLayout.astro";
import ArticleNavigation from "@components/article/ArticleNavigation.astro";
import { getAdjacentPosts } from "@lib/post";
import type { CollectionEntry } from "astro:content";

interface Props {post: CollectionEntry<'blog'>;}

const { post } = Astro.props;
const { title, description, pubDate, author = "匿名作者", tags = [], readingTime, coverImage } = post.data;

// 1. 自动化核心：直接在 Layout 级别获取相邻文章
const { prev, next } = await getAdjacentPosts(post.slug);

// 2. 预处理显示数据
const formattedDate = pubDate?.toLocaleDateString("zh-CN", {year: 'numeric', month: 'long', day: 'numeric'});
---

<BaseLayout {title} {description} ogImage={coverImage}>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <header class="mb-12 text-center">
      {tags.length > 0 && (
          <div class="flex justify-center gap-3 mb-4">
            {tags.map(tag => (
                <span class="text-xs font-bold tracking-widest uppercase text-indigo-600 dark:text-indigo-400">
              #{tag}
            </span>
            ))}
          </div>
      )}

      <h1 class="text-4xl md:text-5xl font-black text-gray-900 dark:text-white mb-6 tracking-tight leading-tight">
        {title}
      </h1>

      <div class="flex items-center justify-center text-sm text-gray-500 dark:text-gray-400 space-x-3 font-medium">
        <span>{author}</span>
        {pubDate && <time datetime={pubDate.toISOString()}>· {formattedDate}</time>}
        {readingTime && <span>· 约 {readingTime} 分钟阅读</span>}
      </div>
    </header>

    {coverImage && (
        <figure class="mb-14 -mx-4 sm:-mx-0">
          <img
              src={coverImage}
              alt={title}
              class="w-full aspect-[21/9] object-cover rounded-2xl shadow-2xl shadow-indigo-500/10 border border-gray-100 dark:border-gray-800"
              loading="eager"
          />
        </figure>
    )}

    <div class="prose prose-custom max-w-none dark:prose-invert">
      <slot />
    </div>

    <footer class="mt-20">
      <ArticleNavigation
          prevArticle={prev ? { title: prev.data.title, slug: prev.slug } : undefined}
          nextArticle={next ? { title: next.data.title, slug: next.slug } : undefined}
      />
    </footer>
  </article>
</BaseLayout>

<style is:global>
  @reference "@/styles/global.css";
  .prose-custom {
    --tw-prose-headings: var(--color-gray-900);
    --tw-prose-links: var(--color-indigo-600);
  }

  .dark .prose-custom {
    --tw-prose-headings: var(--color-white);
    --tw-prose-links: var(--color-indigo-400);
  }
  /* 优化移动端表格和代码块体验 */
  .prose pre { @apply overflow-x-auto rounded-xl border border-gray-200 dark:border-gray-700; }
  .prose table { @apply block overflow-x-auto; }
</style>