---
/**
 * @layout ArticleLayout
 * @description 文章页面布局组件，继承自 BaseLayout
 * @features 三栏布局、目录、相关文章、文章抽屉、阅读进度、图片灯箱
 * @props post - 文章内容数据
 * @props headings - Markdown 标题数组
 */
import BaseLayout from "@layouts/BaseLayout.astro";
import ReadingProgress from "@components/ui/ReadingProgress.astro";
import TableOfContents from "@components/common/TableOfContents.astro";
import ArticleNavigation from "@components/article/ArticleNavigation.astro";
import RelatedPostsByTag from "@components/article/RelatedPostsByTag.astro";
import ArticleDrawer from "@components/common/ArticleDrawer.astro";
import {Icon} from "astro-icon/components";

import {getAdjacentPosts, getRelatedPostsByTags} from "@lib/post";
import {type CollectionEntry} from "astro:content";
import type {MarkdownHeading} from "astro";

interface Props {
    post: CollectionEntry<'blog'>;
    headings: MarkdownHeading[];
}

const {post, headings} = Astro.props;
const {
    title, description, pubDate, author = "Moonpeak",
    tags = [], readingTime, coverImage
} = post.data;

// 获取相邻文章
const {prev, next} = await getAdjacentPosts(post.slug);

// 获取同标签文章
const relatedPosts = await getRelatedPostsByTags(post.slug, tags, 8);

// 判断是否有目录
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
const hasTOC = tocHeadings.length > 0;

const formattedDate = pubDate?.toLocaleDateString("zh-CN", {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});
---

<BaseLayout title={title} description={description} ogImage={coverImage}>
    <ReadingProgress/>

    {/* 文章页面整体背景 - 比默认背景稍深，突出 card */}
    <div class="min-h-screen bg-[#f5f5f5] dark:bg-[#0f0f0f] transition-colors duration-300">

        {/* Hero Header - 在 card 外部 */}
        <header class="pt-24 pb-8 px-4 sm:px-6">
            <div class="max-w-7xl mx-auto">
                <!-- Back Link -->
                <a
                        href="/blog"
                        class="inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors mb-4 group"
                >
                    <Icon name="lucide:arrow-left"
                          class="w-4 h-4 transition-transform duration-300 group-hover:-translate-x-1"/>
                    返回文章列表
                </a>

                <!-- Title 区域 -->
                <div class="max-w-4xl">
                    <!-- Tags -->
                    {tags.length > 0 && (
                            <div class="flex flex-wrap gap-2 mb-3">
                                {tags.map(tag => (
                                        <a
                                                href={`/tags/${tag}/`}
                                                class="tag-base"
                                        >
                                            {tag}
                                        </a>
                                ))}
                            </div>
                    )}

                    <!-- Title -->
                    <h1 class="text-xl md:text-2xl lg:text-3xl font-bold tracking-tight text-foreground mb-4 leading-tight">
                        {title}
                    </h1>

                    <!-- Meta Info -->
                    <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full bg-linear-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                {author.charAt(0)}
                            </div>
                            <span class="font-medium text-foreground">{author}</span>
                        </div>
                        <span class="text-border">|</span>
                        <time datetime={pubDate.toISOString()} class="flex items-center gap-1">
                            <Icon name="lucide:calendar" class="w-3.5 h-3.5"/>
                            {formattedDate}
                        </time>
                        {readingTime && (
                                <>
                                    <span class="text-border">|</span>
                                    <span class="flex items-center gap-1">
                                    <Icon name="lucide:clock" class="w-4 h-4"/>
                                        {readingTime} 分钟
                                </span>
                                </>
                        )}
                    </div>
                </div>
            </div>
        </header>

        {/* Cover Image - 在 card 外部 */}
        {coverImage && (
                <div class="px-4 sm:px-6 mb-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="max-w-4xl">
                            <img
                                    src={coverImage}
                                    alt={title}
                                    class="w-full aspect-[2.5/1] object-cover rounded-xl shadow-sm"
                            />
                        </div>
                    </div>
                </div>
        )}

        {/* Main Content Area - 三栏 Card 布局 */}
        <div class="px-4 sm:px-6 pb-16">
            <div class="max-w-7xl mx-auto">
                <div class="flex gap-4 lg:gap-5">

                    {/* ========== 左侧边栏 - 相关文章 Card ========== */}
                    <aside
                            id="left-sidebar"
                            class:list={[
                                "hidden lg:block shrink-0 transition-all duration-300 ease-out",
                                relatedPosts.length > 0 ? "w-64 opacity-100" : "w-0 opacity-0 overflow-hidden"
                            ]}
                    >
                        <div class="sticky top-20 space-y-4">

                            {/* 相关文章 Card */}
                            <div class="bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                {/* Card Header */}
                                <div class="px-4 py-3 border-b border-border bg-muted/30 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <Icon name="lucide:files" class="w-4 h-4 text-indigo-500"/>
                                        <span class="text-sm font-semibold text-foreground">相关文章</span>
                                    </div>
                                    <button
                                            id="toggle-left-sidebar"
                                            class="p-1 rounded sidebar-toggle"
                                            aria-label="收起"
                                            title="收起侧边栏"
                                    >
                                        <Icon name="lucide:chevron-left" class="w-4 h-4"/>
                                    </button>
                                </div>
                                {/* Card Body */}
                                <div class="p-3">
                                    <RelatedPostsByTag posts={relatedPosts} currentTags={tags}/>
                                </div>
                            </div>

                            {/* 可以添加更多 Card，比如：标签云 */}
                            {tags.length > 0 && (
                                    <div class="bg-background rounded-xl shadow-sm border border-border overflow-hidden">
                                        <div class="px-4 py-3 border-b border-border bg-muted/30">
                                            <div class="flex items-center gap-2">
                                                <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor"
                                                     viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                                </svg>
                                                <span class="text-sm font-semibold text-foreground">文章标签</span>
                                            </div>
                                        </div>
                                        <div class="p-3">
                                            <div class="flex flex-wrap gap-1.5">
                                                {tags.map(tag => (
                                                        <a
                                                                href={`/tags/${tag}/`}
                                                                class="tag-base hover:text-indigo-600 dark:hover:text-indigo-400"
                                                        >
                                                            {tag}
                                                        </a>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                            )}

                        </div>
                    </aside>

                    {/* 左侧展开按钮 - 收起时显示在左侧边缘 */}
                    {relatedPosts.length > 0 && (
                            <button
                                    id="expand-left-sidebar"
                                    class="hidden flex-col items-center gap-1 fixed left-0 top-1/2 -translate-y-1/2 z-40 px-2 py-3 rounded-r-lg card-base rounded-l-none! border-l-0! transition-all duration-300 hover:pl-3"
                                    aria-label="展开相关文章"
                                    title="相关文章"
                            >
                                <Icon name="lucide:files" class="w-4 h-4 text-muted-foreground"/>
                                <span class="text-[10px] text-muted-foreground writing-vertical">相关文章</span>
                            </button>
                    )}

                    {/* ========== 中间主内容 - 文章 Card ========== */}
                    <main class="flex-1 min-w-0">
                        <article class="card-base min-h-150">
                            {/* 文章内容区 */}
                            <div class="p-6 md:p-8 lg:p-10">
                                <div class="prose-custom max-w-none">
                                    <slot/>
                                </div>
                            </div>

                            {/* 分隔线 */}
                            <div class="border-t border-border"></div>

                            {/* 文章底部导航 */}
                            <div class="p-6 md:p-8">
                                <ArticleNavigation
                                        prevArticle={prev ? {title: prev.data.title, slug: prev.slug} : undefined}
                                        nextArticle={next ? {title: next.data.title, slug: next.slug} : undefined}
                                />
                            </div>
                        </article>
                    </main>

                    {/* ========== 右侧边栏 - 目录 Card ========== */}
                    {hasTOC && (
                            <aside
                                    id="right-sidebar"
                                    class="hidden xl:block w-56 shrink-0"
                            >
                                <div class="sticky top-20">
                                    {/* 目录 Card */}
                                    <div class="card-base overflow-hidden">
                                        {/* Card Header */}
                                        <div class="px-4 py-3 border-b border-border bg-muted/30 flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <Icon name="lucide:list" class="w-4 h-4 text-emerald-500"/>
                                                <span class="text-sm font-semibold text-foreground">目录</span>
                                            </div>
                                            <button
                                                    id="toggle-right-sidebar"
                                                    class="p-1 rounded sidebar-toggle"
                                                    aria-label="收起"
                                                    title="收起目录"
                                            >
                                                <Icon name="lucide:chevron-right" class="w-4 h-4"/>
                                            </button>
                                        </div>
                                        {/* Card Body */}
                                        <div class="p-3 max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar">
                                            <TableOfContents headings={tocHeadings}/>
                                        </div>
                                    </div>

                                    {/* 快捷操作 */}
                                    <div class="card-base overflow-hidden mt-4">
                                        <div class="px-4 py-3 border-b border-border bg-muted/30">
                                            <div class="flex items-center gap-2">
                                                <Icon name="lucide:zap" class="w-4 h-4 text-amber-500"/>
                                                <span class="text-sm font-semibold text-foreground">快捷操作</span>
                                            </div>
                                        </div>
                                        <div class="p-3 space-y-2">
                                            <button
                                                    onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                                                    class="w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg action-btn group"
                                            >
                                                <Icon name="lucide:arrow-up"
                                                      class="w-4 h-4 transition-transform duration-300 group-hover:-translate-y-1"/>
                                                回到顶部
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </aside>
                    )}

                    {/* 右侧展开按钮 - 收起时显示在右侧边缘 */}
                    {hasTOC && (
                            <button
                                    id="expand-right-sidebar"
                                    class="hidden flex-col items-center gap-1 fixed right-0 top-1/2 -translate-y-1/2 z-40 px-2 py-3 rounded-l-lg card-base rounded-r-none! border-r-0! transition-all duration-300 hover:pr-3"
                                    aria-label="展开目录"
                                    title="目录"
                            >
                                <Icon name="lucide:list" class="w-4 h-4 text-muted-foreground"/>
                                <span class="text-[10px] text-muted-foreground writing-vertical">目录</span>
                            </button>
                    )}

                </div>
            </div>
        </div>

        {/* Mobile: 底部相关文章 */}
        {relatedPosts.length > 0 && (
                <div class="lg:hidden px-4 sm:px-6 pb-12">
                    <div class="card-base p-4">
                        <div class="flex items-center gap-2 mb-4 pb-3 border-b border-border">
                            <Icon name="lucide:files" class="w-4 h-4 text-indigo-500"/>
                            <span class="text-sm font-semibold text-foreground">相关文章</span>
                        </div>
                        <div class="grid gap-3 sm:grid-cols-2">
                            {relatedPosts.slice(0, 4).map(post => (
                                    <a
                                            href={`/blog/${post.slug}/`}
                                            class="group flex items-start gap-3 p-3 rounded-lg interactive-item"
                                    >
                                        <div class="w-1 h-1 rounded-full bg-indigo-500 mt-2 shrink-0"></div>
                                        <div>
                                            <div class="text-sm text-foreground transition-colors line-clamp-2 group-hover:text-indigo-600 dark:group-hover:text-indigo-400">
                                                {post.data.title}
                                            </div>
                                            <div class="text-xs text-muted-foreground mt-1">
                                                {post.data.pubDate.toLocaleDateString('zh-CN', {
                                                    month: 'short',
                                                    day: 'numeric'
                                                })}
                                            </div>
                                        </div>
                                    </a>
                            ))}
                        </div>
                    </div>
                </div>
        )}
    </div>

    {/* ========== 文章抽屉 ========== */}
    <ArticleDrawer />

    {/* Sidebar Toggle Scripts */}
    <script is:inline>
        // @ts-nocheck - 这是一个纯 JavaScript 文件，禁用 TypeScript 检查
        (function () {
            const leftSidebar = document.getElementById('left-sidebar');
            const leftToggle = document.getElementById('toggle-left-sidebar');
            const leftExpand = document.getElementById('expand-left-sidebar');

            const rightSidebar = document.getElementById('right-sidebar');
            const rightToggle = document.getElementById('toggle-right-sidebar');
            const rightExpand = document.getElementById('expand-right-sidebar');

            // 从 localStorage 读取状态
            const leftCollapsed = localStorage.getItem('left-sidebar-collapsed') === 'true';
            const rightCollapsed = localStorage.getItem('right-sidebar-collapsed') === 'true';

            // 初始化左侧边栏
            if (leftSidebar && leftCollapsed) {
                leftSidebar.style.width = '0';
                leftSidebar.style.opacity = '0';
                leftSidebar.style.marginRight = '-20px';
                if (leftExpand) {
                    leftExpand.style.display = 'flex';
                    leftExpand.style.opacity = '1';
                }
            }

            // 初始化右侧边栏
            if (rightSidebar && rightCollapsed) {
                rightSidebar.style.width = '0';
                rightSidebar.style.opacity = '0';
                rightSidebar.style.marginLeft = '-20px';
                if (rightExpand) {
                    rightExpand.style.display = 'flex';
                    rightExpand.style.opacity = '1';
                }
            }

            // 左侧边栏切换
            leftToggle?.addEventListener('click', () => {
                leftSidebar.style.width = '0';
                leftSidebar.style.opacity = '0';
                leftSidebar.style.marginRight = '-20px';
                localStorage.setItem('left-sidebar-collapsed', 'true');
                if (leftExpand) {
                    setTimeout(() => {
                        leftExpand.style.display = 'flex';
                        leftExpand.style.opacity = '1';
                    }, 300);
                }
            });

            leftExpand?.addEventListener('click', () => {
                leftSidebar.style.width = '16rem'; // w-64
                leftSidebar.style.opacity = '1';
                leftSidebar.style.marginRight = '0';
                leftExpand.style.opacity = '0';
                localStorage.setItem('left-sidebar-collapsed', 'false');
                setTimeout(() => {
                    leftExpand.style.display = 'none';
                }, 300);
            });

            // 右侧边栏切换
            rightToggle?.addEventListener('click', () => {
                rightSidebar.style.width = '0';
                rightSidebar.style.opacity = '0';
                rightSidebar.style.marginLeft = '-20px';
                localStorage.setItem('right-sidebar-collapsed', 'true');
                if (rightExpand) {
                    setTimeout(() => {
                        rightExpand.style.display = 'flex';
                        rightExpand.style.opacity = '1';
                    }, 300);
                }
            });

            rightExpand?.addEventListener('click', () => {
                rightSidebar.style.width = '14rem'; // w-56
                rightSidebar.style.opacity = '1';
                rightSidebar.style.marginLeft = '0';
                rightExpand.style.opacity = '0';
                localStorage.setItem('right-sidebar-collapsed', 'false');
                setTimeout(() => {
                    rightExpand.style.display = 'none';
                }, 300);
            });
        })();
    </script>
</BaseLayout>

<!-- 图片灯箱脚本 -->
<script is:inline>
// @ts-nocheck - 这是一个纯 JavaScript 文件，禁用 TypeScript 检查
(function() {
    // 灯箱状态
    let lightbox = null;
    let lightboxImg = null;
    let isOpen = false;

    // 初始化灯箱
    function initLightbox() {
        // 如果已存在则不再创建
        if (document.getElementById('image-lightbox')) return;

        // 创建灯箱 DOM
        lightbox = document.createElement('div');
        lightbox.id = 'image-lightbox';
        lightbox.className = 'fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300';
        lightbox.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
        lightbox.style.backdropFilter = 'blur(4px)';
        
        // 灯箱内容：图片 + 关闭按钮
        lightbox.innerHTML = `
            <img id="lightbox-img" src="" alt="" class="max-w-[90vw] max-h-[90vh] object-contain scale-95 transition-transform duration-300 rounded-lg shadow-2xl" />
            <button id="lightbox-close" class="absolute top-4 right-4 p-2 text-white/80 hover:text-white transition-colors rounded-full hover:bg-white/10" aria-label="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div id="lightbox-caption" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 text-sm max-w-[80vw] text-center"></div>
        `;
        
        document.body.appendChild(lightbox);
        lightboxImg = document.getElementById('lightbox-img');

        // 点击关闭
        lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox || e.target.closest('#lightbox-close')) {
                closeLightbox();
            }
        });

        // ESC 关闭
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isOpen) {
                closeLightbox();
            }
        });
    }

    // 打开灯箱
    function openLightbox(img) {
        if (!lightbox) initLightbox();
        
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt || '';
        
        // 设置图片说明（如果有 alt 文本）
        const caption = document.getElementById('lightbox-caption');
        caption.textContent = img.alt || '';
        caption.style.display = img.alt ? 'block' : 'none';
        
        // 显示灯箱
        lightbox.classList.remove('opacity-0', 'pointer-events-none');
        lightbox.classList.add('opacity-100', 'pointer-events-auto');
        
        // 图片放大动画
        setTimeout(() => {
            lightboxImg.classList.remove('scale-95');
            lightboxImg.classList.add('scale-100');
        }, 10);
        
        isOpen = true;
        document.body.style.overflow = 'hidden'; // 禁止背景滚动
    }

    // 关闭灯箱
    function closeLightbox() {
        if (!lightbox || !isOpen) return;
        
        lightboxImg.classList.remove('scale-100');
        lightboxImg.classList.add('scale-95');
        lightbox.classList.remove('opacity-100', 'pointer-events-auto');
        lightbox.classList.add('opacity-0', 'pointer-events-none');
        
        isOpen = false;
        document.body.style.overflow = ''; // 恢复背景滚动
    }

    // 绑定图片点击事件
    function bindImages() {
        // 只绑定文章内容区的图片
        const articleContent = document.querySelector('.prose-custom');
        if (!articleContent) return;

        const images = articleContent.querySelectorAll('img');
        images.forEach(img => {
            // 跳过已绑定的图片
            if (img.dataset.lightboxBound) return;
            
            // 添加点击样式
            img.style.cursor = 'zoom-in';
            img.classList.add('hover:opacity-90', 'transition-opacity');
            
            // 绑定点击事件
            img.addEventListener('click', function(e) {
                e.preventDefault();
                openLightbox(img);
            });
            
            img.dataset.lightboxBound = 'true';
        });
    }

    // 初始化
    function init() {
        initLightbox();
        bindImages();
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Swup 页面过渡后重新绑定
    if (window.SwupCompat) {
        window.SwupCompat.onPageView(init);
    } else {
        document.addEventListener('swup:contentReplaced', init);
        document.addEventListener('astro:page-load', init);
    }
})();
</script>

<style>
    /* 垂直文字 */
    .writing-vertical {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        letter-spacing: 0.1em;
    }
</style>
