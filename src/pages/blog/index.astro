---
// src/pages/blog/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import Pagination from "../../components/Pagination.astro";
import PageSiderBar from "@/components/PageSiderBar.astro";
import { taxonomyService } from "@/lib/utils/optimizedTaxonomy";

const allPosts = (await getCollection("blog")).sort(
    (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
        new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
);

const POSTS_PER_PAGE = 10;
const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const posts = allPosts.slice(0, POSTS_PER_PAGE);
const categoriesTemp = await taxonomyService.getTaxonomy("blog", "categories");
const tagsTemp = await taxonomyService.getTaxonomy("blog", "tags");
const categories = categoriesTemp.map((item: any) => item.name);
const tags = tagsTemp.map((item: any) => item.name);
---

<BaseLayout title="博客文章" description="探索技术文章和教程">
    <div
        class="max-w-8xl min-h-screen mx-auto p-4 sm:p-8 flex flex-row justify-center "
    >
        <PageSiderBar
            categories={categories}
            tags={tags}
            allCategories={categories}
        />
        <div class="flex-1">
            <section class="space-y-6 flex flex-col">
                <h1
                    class="text-4xl font-extrabold mb-10 text-center text-gray-900 dark:text-gray-100"
                >
                    111
                </h1>
                {
                    posts.map((post: CollectionEntry< "blog">) => (
                        <a
                            href={`/blog/post/${post.slug}/`}
                            class="block border shadow-lg border-gray-200 rounded-xl p-5 transition duration-300 ease-in-out bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                        >
                            <article>
                                <h2 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400 mb-2">
                                    {post.data.title}
                                </h2>

                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-3 space-x-2">
                                    <time
                                        datetime={post.data.pubDate.toISOString()}
                                    >
                                        {new Date(
                                            post.data.pubDate,
                                        ).toLocaleDateString("zh-CN")}
                                    </time>
                                    <span>•</span>
                                    <span>作者: {post.data.author}</span>
                                    {post.data.readingTime && (
                                        <>
                                            <span>•</span>
                                            <span>
                                                阅读时间:{" "}
                                                {post.data.readingTime} 分钟
                                            </span>
                                        </>
                                    )}
                                </div>

                                <p class="text-base text-gray-700 dark:text-gray-300 line-clamp-2 mb-3">
                                    {post.data.description}
                                </p>

                                {post.data.tags &&
                                    post.data.tags.length > 0 && (
                                        <div class="flex flex-wrap gap-2">
                                            {post.data.tags
                                                .slice(0, 3)
                                                .map((tag: string) => (
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                                        #{tag}
                                                    </span>
                                                ))}
                                            {post.data.tags.length > 3 && (
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                                    +{post.data.tags.length - 3}
                                                </span>
                                            )}
                                        </div>
                                    )}
                            </article>
                        </a>
                    ))
                }
            </section>
            {
                allPosts.length === 0 && (
                    <div class="text-center py-12">
                        <p class="text-xl text-gray-500 dark:text-gray-400 mb-4">
                            还没有发布任何文章
                        </p>
                        <p class="text-sm text-gray-400 dark:text-gray-500">
                            敬请期待...
                        </p>
                    </div>
                )
            }

            {
                totalPages > 1 && (
                    <>
                        <Pagination
                            section="blog"
                            currentPage={currentPage}
                            totalPages={totalPages}
                            basePath="/page"
                        />
                        <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
                            第 {currentPage} 页，共 {totalPages} 页，显示{" "}
                            {posts.length} 篇文章（总计 {allPosts.length} 篇）
                        </div>
                    </>
                )
            }
        </div>
    </div>
</BaseLayout>
