---
// src/pages/blog/page/[page].astro
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import Pagination from "@/components/Pagination.astro";
import PageSiderBar from "@/components/PageSiderBar.astro";
import { taxonomyService } from '@/lib/utils/optimizedTaxonomy';
import type { any } from "astro:schema";

export async function getStaticPaths() {
  const allPosts = (await getCollection("blog")).sort(
    (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );
  
  const POSTS_PER_PAGE = 10;
  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
  
  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const startIndex = (page - 1) * POSTS_PER_PAGE;
    const endIndex = startIndex + POSTS_PER_PAGE;
    
    return {
      params: { page: page.toString() },
      props: {
        currentPage: page,
        totalPages,
        posts: allPosts.slice(startIndex, endIndex),
        totalPosts: allPosts.length
      }
    };
  });
}
const { currentPage, totalPages, posts, totalPosts } = Astro.props;
const categoriesTemp = await taxonomyService.getTaxonomy("blog", "categories");
const tagsTemp = await taxonomyService.getTaxonomy("blog", "tags");
const categories = categoriesTemp.map((item : any) => item.name);
const tags = tagsTemp.map((item : any) => item.name);
// console.log('Categories:', categories);
// console.log('Tags:', tags);
---

<BaseLayout title={`博客文章 - 第${currentPage}页`} description={`探索技术文章和教程 - 第${currentPage}页`}>
    <div class="max-w-7xl min-h-screen mx-auto p-4 sm:p-8">
        <PageSiderBar
          categories={categories}
          tags={tags}
          allCategories={categories}
        />
        <h1 class="text-4xl font-extrabold mb-10 text-center text-gray-900 dark:text-gray-100">
            博客文章 {currentPage > 1 && `- 第${currentPage}页`}
        </h1>

        <section class="space-y-6">
            {posts.map((post) => (
                <a
                    href={`/blog/post/${post.slug}/`}
                    class="block border shadow-lg border-gray-200 rounded-xl p-5 transition duration-300 ease-in-out bg-white hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                >
                    <article>
                        <h2 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400 mb-2">
                            {post.data.title}
                        </h2>
                        
                        <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-3 space-x-2">
                            {post.data.pubDate && (
                            <time datetime={post.data.pubDate.toISOString()}>
                                {new Date(post.data.pubDate).toLocaleDateString('zh-CN')}
                            </time>
                            <span>•</span>
                            <span>作者: {post.data.author}</span>)
                            }
                            {post.data.readingTime && (
                                    <span>•</span>
                                    <span>阅读时间: {post.data.readingTime} 分钟</span>
                            )}
                            
                        </div>

                        <p class="text-base text-gray-700 dark:text-gray-300 line-clamp-2 mb-3">
                            {post.data.description}
                        </p>

                        {post.data.tags && post.data.tags.length > 0 && (
                            <div class="flex flex-wrap gap-2">
                                {post.data.tags.slice(0, 3).map((tag: string) => (
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                        #{tag}
                                    </span>
                                ))}
                                {post.data.tags.length > 3 && (
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                        +{post.data.tags.length - 3}
                                    </span>
                                )}
                            </div>
                        )}
                    </article>
                </a>
            ))}
        </section>

        {posts.length === 0 && (
            <div class="text-center py-12">
                <p class="text-xl text-gray-500 dark:text-gray-400 mb-4">
                    该页面没有文章
                </p>
                <a href="/blog" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">
                    返回博客首页
                </a>
            </div>
        )}

        {totalPages > 1 && (
            <>
                <Pagination
                    section="blog"
                    currentPage={currentPage}
                    totalPages={totalPages}
                    basePath="/page"
                />
                <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
                    第 {currentPage} 页，共 {totalPages} 页，显示 {posts.length} 篇文章（总计 {totalPosts} 篇）
                </div>
            </>
        )}
    </div>
</BaseLayout>