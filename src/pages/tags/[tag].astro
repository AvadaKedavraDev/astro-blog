---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();
  
  posts.forEach(post => {
    post.data.tags?.forEach(tag => tagSet.add(tag));
  });
  
  return Array.from(tagSet).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;

const allPosts = (await getCollection("blog")).sort(
  (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

const taggedPosts = allPosts.filter(post => 
  post.data.tags?.includes(tag)
);

const allTags = new Map<string, number>();
allPosts.forEach(post => {
  post.data.tags?.forEach(t => {
    allTags.set(t, (allTags.get(t) || 0) + 1);
  });
});
---

<BaseLayout title={`标签：${tag}`} description={`查看所有包含「${tag}」标签的文章`}>
  <div class="pt-32 pb-24 px-6">
    <div class="container-narrow">
      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-3 mb-4">
          <a 
            href="/tags" 
            class="text-sm text-muted-foreground hover:text-foreground transition-colors"
          >
            所有标签
          </a>
          <span class="text-muted-foreground">/</span>
          <span class="text-sm text-foreground">{tag}</span>
        </div>
        
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-2">
          #{tag}
        </h1>
        <p class="text-sm text-muted-foreground">
          共 {taggedPosts.length} 篇文章
        </p>
      </header>
      
      <!-- Posts List -->
      <div class="space-y-1">
        {taggedPosts.map((post) => (
          <article class="group">
            <a href={`/blog/${post.slug}/`} class="block">
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-5 py-5 list-item-base">
                <!-- Date -->
                <time class="text-sm text-muted-foreground font-mono shrink-0 w-24">
                  {post.data.pubDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                  }).replace(/\//g, '.')}
                </time>
                
                <!-- Content -->
                <div class="flex-1 min-w-0">
                  <h2 class="text-base md:text-lg font-medium text-foreground transition-colors group-hover:opacity-80">
                    {post.data.title}
                  </h2>
                  {post.data.description && (
                    <p class="text-sm text-muted-foreground line-clamp-1 mt-0.5">
                      {post.data.description}
                    </p>
                  )}
                </div>
                
                <!-- Tags -->
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="hidden lg:flex items-center gap-1.5 shrink-0">
                    {post.data.tags.slice(0, 2).map(t => (
                      <span class:list={[
                        "px-2 py-0.5 text-xs rounded-full",
                        t === tag 
                          ? "bg-foreground text-background" 
                          : "bg-muted text-muted-foreground"
                      ]}>
                        {t}
                      </span>
                    ))}
                  </div>
                )}
                
                <!-- Arrow -->
                <div class="hidden sm:block opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all">
                  <svg class="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>
      
      <!-- Empty State -->
      {taggedPosts.length === 0 && (
        <div class="text-center py-24">
          <p class="text-muted-foreground">该标签下暂无文章</p>
        </div>
      )}
      
      <!-- Other Tags -->
      {allTags.size > 1 && (
        <div class="mt-16 pt-8 border-t border-border">
          <h2 class="text-sm font-medium text-foreground mb-4">其他标签</h2>
          <div class="flex flex-wrap gap-2">
            {Array.from(allTags.entries())
              .filter(([t]) => t !== tag)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 15)
              .map(([t, count]) => (
                <a
                  href={`/tags/${t}/`}
                  class="px-3 py-1.5 text-sm rounded-lg bg-muted text-muted-foreground hover:bg-foreground hover:text-background transition-colors"
                >
                  {t} ({count})
                </a>
              ))
            }
          </div>
        </div>
      )}
    </div>
  </div>
</BaseLayout>
